<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Sosialiasi Pemanfaatan BP Tapera</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Tailwind untuk warna dan font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tapera-green': '#009045', // Hijau Khas (Contoh)
                        'tapera-light': '#E6F0E9', // Hijau Muda
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Gaya tambahan untuk input focus */
        input:focus, select:focus, textarea:focus {
            border-color: #009045 !important;
            box-shadow: 0 0 0 3px rgba(0, 144, 69, 0.3) !important;
        }
        /* Custom style untuk menghilangkan panah default di select */
        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%234a5568' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        .loading-spinner {
            border-top-color: #009045;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-tapera-light min-h-screen flex items-center justify-center p-4 sm:p-8 font-sans">

    <div class="w-full max-w-4xl bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header / Kop Formulir (Dominasi Hijau) -->
        <header class="bg-tapera-green text-white p-6 sm:p-8 flex items-center space-x-4">
            <!-- Logo BP Tapera Placeholder (Gunakan placeholder berwarna putih agar kontras) -->
            <img 
                src="logo/Logo_Tapera.png" 
                alt="Logo BP Tapera" 
                class="rounded-full shadow-md"
                onerror="this.onerror=null; this.src='https://placehold.co/60x60/ffffff/009045?text=LOGO';"
            >
            <div>
                <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">FORMULIR PEMINATAN RUMAH FLPP</h1>
                <p class="text-sm sm:text-base font-light opacity-90">Badan Pengelola Tabungan Perumahan Rakyat (BP Tapera)</p>
            </div>
        </header>

        <!-- Form Body -->
        <form class="p-6 sm:p-10 space-y-6" onsubmit="handleSubmit(event)">

            <!-- 1. Nomor NIK -->
            <div>
                <label for="nik" class="block text-sm font-medium text-gray-700 mb-1">1. Nomor NIK <span class="text-red-500">*</span></label>
                <input type="text" id="nik" name="nik" 
                       placeholder="Masukkan 16 digit NIK Anda"
                       pattern="\d{16}"
                       maxlength="16"
                       required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none text-gray-900 transition duration-150">
            </div>

            <!-- 2. Nama Lengkap -->
            <div>
                <label for="nama_lengkap" class="block text-sm font-medium text-gray-700 mb-1">2. Nama Lengkap <span class="text-red-500">*</span></label>
                <input type="text" id="nama_lengkap" name="nama_lengkap" 
                       placeholder="Nama Lengkap sesuai KTP"
                       required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none text-gray-900 transition duration-150">
            </div>

            <!-- 3. Nomor HP -->
            <div>
                <label for="nomor_hp" class="block text-sm font-medium text-gray-700 mb-1">3. Nomor HP Aktif <span class="text-red-500">*</span></label>
                <input type="tel" id="nomor_hp" name="nomor_hp" 
                       placeholder="Contoh: 081234567890"
                       required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none text-gray-900 transition duration-150">
            </div>

            <!-- 4. Nama Instansi/Perusahaan/Tempat bekerja -->
            <div>
                <label for="instansi" class="block text-sm font-medium text-gray-700 mb-1">4. Nama Instansi/Perusahaan/Tempat Bekerja <span class="text-red-500">*</span></label>
                <input type="text" id="instansi" name="instansi" 
                       placeholder="Masukkan nama instansi/perusahaan Anda"
                       required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none text-gray-900 transition duration-150">
            </div>

            <!-- 5. Lokasi Perumahan yang Diminati (Dinamis - API) -->
            <fieldset class="border border-tapera-green/50 p-4 rounded-lg">
                <legend class="text-base font-semibold text-tapera-green px-2">5. Lokasi Perumahan yang Diminati <span class="text-red-500">*</span></legend>
                <p class="text-xs text-gray-500 mb-4">Data wilayah dimuat dari API Kemendagri (emsifa.com)</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    
                    <!-- a. Provinsi -->
                    <div>
                        <label for="provinsi" class="block text-xs font-medium text-gray-700 mb-1">a. Provinsi</label>
                        <select id="provinsi" name="provinsi" required onchange="loadCities(this.value)"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none bg-white text-gray-900 transition duration-150">
                            <option value="">-- Memuat Provinsi... --</option>
                        </select>
                    </div>

                    <!-- b. Kab/Kota (Dinamis berdasarkan Provinsi) -->
                    <div>
                        <label for="kab_kota" class="block text-xs font-medium text-gray-700 mb-1">b. Kab/Kota</label>
                        <select id="kab_kota" name="kab_kota" required onchange="loadDistricts(this.value)" disabled
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none bg-white text-gray-900 transition duration-150 disabled:bg-gray-100 disabled:text-gray-500">
                            <option value="">-- Pilih Kab/Kota --</option>
                        </select>
                    </div>

                    <!-- c. Kecamatan (Dinamis berdasarkan Kab/Kota) -->
                    <div>
                        <label for="kecamatan" class="block text-xs font-medium text-gray-700 mb-1">c. Kecamatan</label>
                        <select id="kecamatan" name="kecamatan" required disabled
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none bg-white text-gray-900 transition duration-150 disabled:bg-gray-100 disabled:text-gray-500">
                            <option value="">-- Pilih Kecamatan --</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- 6. Status Pernikahan -->
            <fieldset>
                <legend class="text-sm font-medium text-gray-700 mb-2">6. Status Pernikahan <span class="text-red-500">*</span></legend>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center">
                        <input id="belum_menikah" name="status_nikah" type="radio" value="Belum menikah" required
                               onclick="togglePasanganFields(false)"
                               class="focus:ring-tapera-green h-4 w-4 text-tapera-green border-gray-300">
                        <label for="belum_menikah" class="ml-2 block text-sm text-gray-700">a. Belum menikah</label>
                    </div>
                    <div class="flex items-center">
                        <input id="sudah_menikah" name="status_nikah" type="radio" value="Sudah menikah"
                               onclick="togglePasanganFields(true)"
                               class="focus:ring-tapera-green h-4 w-4 text-tapera-green border-gray-300">
                        <label for="sudah_menikah" class="ml-2 block text-sm text-gray-700">b. Sudah menikah</label>
                    </div>
                </div>

                <!-- Form Input Pasangan (Tampil jika Sudah Menikah dipilih) -->
                <div id="pasangan_fields" class="mt-4 space-y-4 p-4 border-l-4 border-tapera-green bg-tapera-light/50 hidden">
                    <!-- NIK Pasangan -->
                    <div>
                        <label for="nik_pasangan" class="block text-sm font-medium text-gray-700 mb-1">NIK Pasangan <span class="text-red-500">*</span></label>
                        <input type="text" id="nik_pasangan" name="nik_pasangan" 
                               placeholder="Masukkan 16 digit NIK Pasangan"
                               pattern="\d{16}"
                               maxlength="16"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none text-gray-900 transition duration-150">
                    </div>
                    <!-- Nama Pasangan -->
                    <div>
                        <label for="nama_pasangan" class="block text-sm font-medium text-gray-700 mb-1">Nama Pasangan <span class="text-red-500">*</span></label>
                        <input type="text" id="nama_pasangan" name="nama_pasangan" 
                               placeholder="Nama Lengkap Pasangan sesuai KTP"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none text-gray-900 transition duration-150">
                    </div>
                </div>
            </fieldset>

            <!-- 7. Pilih Bank Penyalur (Dinamis) -->
            <div>
                <label for="bank_penyalur" class="block text-sm font-medium text-gray-700 mb-1">7. Pilih Bank Penyalur <span class="text-red-500">*</span></label>
                <select id="bank_penyalur" name="bank_penyalur" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none bg-white text-gray-900 transition duration-150">
                    <option value="">-- Pilih Bank Penyalur BP Tapera --</option>
                    <!-- Options will be loaded by JavaScript -->
                </select>
            </div>
            
            <!-- 8. Persetujuan Dihubungi -->
            <fieldset class="pt-4 border-t border-gray-200">
                <legend class="text-sm font-medium text-gray-700 mb-2">8. Apakah bersedia dihubungi oleh Bank/Developer? <span class="text-red-500">*</span></legend>
                <div class="flex flex-wrap gap-4">
                    <div class="flex items-center">
                        <input id="bersedia_ya" name="bersedia_dihubungi" type="radio" value="Ya" required
                               class="focus:ring-tapera-green h-4 w-4 text-tapera-green border-gray-300">
                        <label for="bersedia_ya" class="ml-2 block text-sm text-gray-700">a. Ya</label>
                    </div>
                    <div class="flex items-center">
                        <input id="bersedia_tidak" name="bersedia_dihubungi" type="radio" value="Tidak"
                               class="focus:ring-tapera-green h-4 w-4 text-tapera-green border-gray-300">
                        <label for="bersedia_tidak" class="ml-2 block text-sm text-gray-700">b. Tidak</label>
                    </div>
                </div>
            </fieldset>

            <!-- 9. Persetujuan Data -->
            <div class="flex items-start pt-4 border-t border-gray-200">
                <div class="flex items-center h-5">
                    <input id="persetujuan" name="persetujuan" type="checkbox" required
                           class="focus:ring-tapera-green h-4 w-4 text-tapera-green border-gray-300 rounded">
                </div>
                <div class="ml-3 text-sm">
                    <label for="persetujuan" class="font-medium text-gray-700">
                        9. Saya menyetujui bahwa data ini dapat digunakan oleh BP Tapera dan Bank Penyalur untuk keperluan verifikasi dan analisis program Tapera. <span class="text-red-500">*</span>
                    </label>
                </div>
            </div>

            <!-- Tombol Submit -->
            <div class="pt-6">
                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-tapera-green hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-tapera-green transition duration-150 transform hover:scale-[1.01]">
                    Kirim Formulir Peminatan
                </button>
            </div>

        </form>

    </div>

    <script>
        // Data Bank Penyalur BP Tapera dari image yang diupload
        const channelingBanks = [
            "BANK BTN", "BTN SYARIAH", "BANK BRI", "BANK BNI", "BANK MANDIRI", 
            "BPD JAWA TENGAH", "BPD JAWA BARAT DAN BANTEN", "BANK SYARIAH INDONESIA", 
            "BJB SYARIAH", "BPD SUMATERA UTARA", "BPD SUMSEL BABEL", 
            "BPD JATENG SYARIAH", "BANK DKI", "BANK SUMSEL BABEL SYARIAH", 
            "BANK JAMBI", "BPD KALIMANTAN SELATAN SYARIAH", "BPD SUMATERA UTARA SYARIAH", 
            "BPD SULAWESI SELATAN", "BPD JAWA TIMUR SYARIAH", "BPD SULAWESI SELATAN SYARIAH", 
            "BANK DKI SYARIAH", "BPD KALIMANTAN BARAT", "BANK NAGARI", 
            "NTB SYARIAH", "BPD KALIMANTAN TENGAH", "BPD RIAU KEPRI SYARIAH", 
            "BPD ACEH", "BPD KALIMANTAN TIMUR", "BPD JAWA TIMUR", 
            "BPD KALIMANTAN SELATAN", "BANK NTT", "BPD KALIMANTAN BARAT SYARIAH", 
            "BANK ARTHA GRAHA", "BANK JAMBI SYARIAH", "BANK NOBU", 
            "BANK NAGARI SYARIAH", "BPD YOGYA", "Bank Mega Syariah", 
            "BPD SULAWESI TENGAH", "BPD PAPUA", "BPD BENGKULU"
        ];
        
        // Base URL untuk API Wilayah
        const API_BASE_URL = 'https://www.emsifa.com/api-wilayah-indonesia/api/';

        /**
         * Helper function untuk fetch data dengan exponential backoff retry.
         * @param {string} url - URL endpoint API.
         * @param {number} retries - Jumlah percobaan ulang.
         */
        async function fetchData(url, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        // Throw error if response is not ok (e.g., 404, 500)
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    // Retry logic
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s delay
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Failed to fetch data after multiple retries:", error);
                        throw error;
                    }
                }
            }
        }

        /**
         * Mengisi dropdown dengan opsi.
         * @param {HTMLElement} selectElement - Elemen <select> yang akan diisi.
         * @param {Array<Object>} data - Array data {id, name}.
         * @param {string} defaultText - Teks opsi default.
         */
        function populateSelect(selectElement, data, defaultText) {
            selectElement.innerHTML = `<option value="">-- ${defaultText} --</option>`;
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name;
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        }

        /**
         * Menampilkan indikator loading.
         * @param {HTMLElement} selectElement - Elemen <select> yang sedang dimuat.
         * @param {string} loadingText - Teks loading.
         */
        function showLoading(selectElement, loadingText) {
            selectElement.disabled = true;
            selectElement.innerHTML = `<option value="">-- ${loadingText} --</option>`;
        }


        /**
         * 1. Mengisi dropdown Provinsi dari API.
         */
        async function loadProvinces() {
            const selectProvinsi = document.getElementById('provinsi');
            try {
                showLoading(selectProvinsi, 'Memuat Provinsi...');
                const data = await fetchData(API_BASE_URL + 'provinces.json');
                populateSelect(selectProvinsi, data, 'Pilih Provinsi');
            } catch (error) {
                selectProvinsi.innerHTML = '<option value="">-- Gagal memuat data Provinsi --</option>';
            }
        }

        /**
         * 2. Mengisi dropdown Kabupaten/Kota berdasarkan Provinsi.
         * @param {string} provinceId - ID provinsi yang dipilih.
         */
        async function loadCities(provinceId) {
            const selectKota = document.getElementById('kab_kota');
            const selectKecamatan = document.getElementById('kecamatan');
            
            // Reset downstream selects
            selectKota.innerHTML = '<option value="">-- Pilih Kab/Kota --</option>';
            selectKecamatan.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
            selectKota.disabled = true;
            selectKecamatan.disabled = true;

            if (provinceId) {
                try {
                    showLoading(selectKota, 'Memuat Kab/Kota...');
                    const data = await fetchData(API_BASE_URL + `regencies/${provinceId}.json`);
                    populateSelect(selectKota, data, 'Pilih Kab/Kota');
                } catch (error) {
                    selectKota.innerHTML = '<option value="">-- Gagal memuat Kab/Kota --</option>';
                }
            }
        }

        /**
         * 3. Mengisi dropdown Kecamatan berdasarkan Kabupaten/Kota.
         * @param {string} cityId - ID kota/kabupaten yang dipilih.
         */
        async function loadDistricts(cityId) {
            const selectKecamatan = document.getElementById('kecamatan');
            
            // Reset downstream select
            selectKecamatan.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
            selectKecamatan.disabled = true;

            if (cityId) {
                try {
                    showLoading(selectKecamatan, 'Memuat Kecamatan...');
                    const data = await fetchData(API_BASE_URL + `districts/${cityId}.json`);
                    populateSelect(selectKecamatan, data, 'Pilih Kecamatan');
                } catch (error) {
                    selectKecamatan.innerHTML = '<option value="">-- Gagal memuat Kecamatan --</option>';
                }
            }
        }
        
        /**
         * Mengisi dropdown Bank Penyalur.
         */
        function loadBanks() {
            const selectBank = document.getElementById('bank_penyalur');
            
            channelingBanks.sort().forEach(bankName => {
                const option = document.createElement('option');
                // Menggunakan nama bank sebagai value yang dinormalisasi (huruf kecil dan spasi diganti underscore)
                option.value = bankName.replace(/\s/g, '_').toLowerCase(); 
                option.textContent = bankName;
                selectBank.appendChild(option);
            });
        }

        /**
         * Fungsi untuk menampilkan atau menyembunyikan field input pasangan.
         */
        function togglePasanganFields(show) {
            const pasanganFields = document.getElementById('pasangan_fields');
            const nikPasangan = document.getElementById('nik_pasangan');
            const namaPasangan = document.getElementById('nama_pasangan');
            
            if (show) {
                pasanganFields.classList.remove('hidden');
                // Mengatur required hanya saat terlihat
                nikPasangan.setAttribute('required', 'required');
                namaPasangan.setAttribute('required', 'required');
            } else {
                pasanganFields.classList.add('hidden');
                // Menghapus required dan mengosongkan nilai saat tersembunyi
                nikPasangan.removeAttribute('required');
                namaPasangan.removeAttribute('required');
                nikPasangan.value = '';
                namaPasangan.value = '';
            }
        }

        /**
         * Fungsi untuk menangani pengiriman formulir (hanya untuk simulasi).
         */
        function handleSubmit(event) {
            event.preventDefault(); // Mencegah pengiriman form default

            const formData = new FormData(event.target);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            const successMessage = document.createElement('div');
            successMessage.className = 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50';
            successMessage.innerHTML = `
                <div class="bg-white p-8 rounded-lg shadow-xl max-w-sm text-center">
                    <svg class="mx-auto h-12 w-12 text-tapera-green" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Formulir Terkirim!</h3>
                    <p class="mt-2 text-sm text-gray-500">Terima kasih atas partisipasi Anda. Data Anda telah kami terima.</p>
                    <button type="button" onclick="window.location.reload()" 
                            class="mt-5 w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-tapera-green text-base font-medium text-white hover:bg-green-700 focus:outline-none sm:text-sm transition duration-150">
                        Tutup
                    </button>
                </div>
            `;
            document.body.appendChild(successMessage);

            console.log("Data Formulir yang Dikirim (Simulasi):", data);
        }

        // Panggil fungsi-fungsi pengisian data saat halaman dimuat
        window.onload = function() {
            loadProvinces(); // Memuat Provinsi dari API
            loadBanks(); // Memuat Bank dari data statis
            togglePasanganFields(false);
        };
    </script>
</body>
</html>
