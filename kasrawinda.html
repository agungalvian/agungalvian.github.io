<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Keuangan Rawinda Pratama (Dinamis)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden-section { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Table sticky headers for large tables */
        .sticky-col { position: sticky; left: 0; background-color: #f9fafb; z-index: 10; }
        .sticky-col-2 { position: sticky; left: 60px; background-color: #f9fafb; z-index: 10; }
    </style>
</head>
<body class="text-gray-800 antialiased h-screen flex flex-col overflow-hidden">

    <!-- NOTIFICATION TOAST -->
    <div id="toast-container" class="fixed top-5 right-5 z-[60] flex flex-col gap-2"></div>

    <!-- ========================================== -->
    <!-- 1. HALAMAN LOGIN -->
    <!-- ========================================== -->
    <section id="page-login" class="flex-1 flex flex-col justify-center items-center p-6 bg-slate-900 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden opacity-20">
            <i class="fa-solid fa-money-bill-wave text-9xl absolute -top-10 -left-10 text-white transform rotate-12"></i>
        </div>

        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md z-10 fade-in">
            <div class="text-center mb-8">
                <div class="h-16 w-16 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-500/50">
                    <i class="fa-solid fa-house-chimney text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Rawinda Pratama</h1>
                <p class="text-gray-500 text-sm mt-1">Sistem Manajemen Keuangan Terpadu</p>
            </div>

            <form onsubmit="handleLogin(event)">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition" placeholder="admin / warga / b2-10">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition shadow-lg">Masuk Aplikasi</button>
            </form>

            <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 text-xs text-blue-800">
                <p class="font-bold mb-1"><i class="fa-solid fa-circle-info mr-1"></i> Akun Demo:</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li><b>Admin:</b> user: <code>admin</code> pass: <code>admin</code></li>
                    <li><b>Warga:</b> user: <code>warga</code> pass: <code>warga</code> (Budi A1-05)</li>
                    <li><b>Warga 2:</b> user: <code>b2-10</code> pass: <code>1234</code> (Siti B2-10)</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- ========================================== -->
    <!-- 2. HALAMAN DASHBOARD WARGA -->
    <!-- ========================================== -->
    <section id="page-warga" class="flex-1 flex flex-col h-full bg-gray-50 hidden-section">
        <nav class="bg-white border-b border-gray-200 shadow-sm z-30 sticky top-0">
            <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <span class="text-blue-600 text-lg font-bold mr-6"><i class="fa-solid fa-house-user mr-2"></i>Rawinda App</span>
                        <div class="hidden md:flex space-x-1">
                            <button onclick="switchWargaTab('home')" id="btn-warga-home" class="px-3 py-2 rounded-md text-sm font-medium bg-blue-50 text-blue-700 transition">Beranda</button>
                            <button onclick="switchWargaTab('laporan')" id="btn-warga-laporan" class="px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition">Laporan</button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-bold text-gray-700" id="warga-nav-name">Nama Warga</p>
                            <p class="text-xs text-gray-500" id="warga-nav-blok">Blok - No</p>
                        </div>
                        <button onclick="logout()" class="text-red-500 hover:text-red-700 text-sm font-semibold ml-2"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-50">
            <div class="max-w-5xl mx-auto">
                <!-- VIEW HOME -->
                <div id="warga-view-home" class="fade-in space-y-6">
                    <!-- Status Tagihan Dinamis -->
                    <!-- KARTU TAGIHAN (DEFAULT RED) -->
                    <div id="card-tagihan" class="bg-white rounded-xl shadow-sm border-l-4 border-red-500 overflow-hidden transition-all duration-300">
                        <div id="card-tagihan-bg" class="p-6 flex flex-col sm:flex-row justify-between items-center bg-red-50/50">
                            <div class="mb-4 sm:mb-0">
                                <p id="card-tagihan-title" class="text-sm text-red-600 font-bold flex items-center">
                                    <i class="fa-solid fa-triangle-exclamation mr-2"></i> Tagihan Belum Dibayar
                                </p>
                                <p class="text-3xl font-extrabold text-gray-800 mt-2" id="warga-bill-amount">Rp 0</p>
                                <p id="card-tagihan-desc" class="text-xs text-gray-500 mt-1">Akumulasi Bulan Berjalan</p>
                            </div>
                            <button id="btn-bayar-utama" onclick="openPaymentModal()" class="bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-8 rounded-lg shadow-md transition transform hover:scale-105">
                                <i class="fa-solid fa-upload mr-2"></i> Bayar Sekarang
                            </button>
                        </div>
                    </div>

                    <!-- Transparansi Cards (Global Balance) -->
                    <div>
                        <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-chart-simple mr-2 text-blue-600"></i> Transparansi Dana Komplek</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-blue-600 rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
                                <div class="relative z-10">
                                    <p class="text-blue-100 text-xs uppercase font-bold">Total Saldo Kas</p>
                                    <p class="text-2xl font-bold mt-1" id="global-saldo-total">Rp 0</p>
                                    <div class="mt-4 text-xs bg-blue-800 bg-opacity-50 inline-block px-2 py-1 rounded">Realtime</div>
                                </div>
                                <i class="fa-solid fa-wallet absolute right-4 bottom-4 text-white text-6xl opacity-20"></i>
                            </div>
                            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                                <p class="text-gray-500 text-xs uppercase font-bold">Kas Perumahan</p>
                                <p class="text-xl font-bold text-gray-800 mt-1" id="global-saldo-housing">Rp 0</p>
                                <div class="w-full bg-gray-100 h-1.5 rounded-full mt-3"><div class="bg-blue-500 h-1.5 rounded-full" style="width: 70%"></div></div>
                            </div>
                            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                                <p class="text-gray-500 text-xs uppercase font-bold">Dana Sosial</p>
                                <p class="text-xl font-bold text-gray-800 mt-1" id="global-saldo-social">Rp 0</p>
                                <div class="w-full bg-gray-100 h-1.5 rounded-full mt-3"><div class="bg-green-500 h-1.5 rounded-full" style="width: 45%"></div></div>
                            </div>
                            <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                                <p class="text-gray-500 text-xs uppercase font-bold">Kas RT</p>
                                <p class="text-xl font-bold text-gray-800 mt-1" id="global-saldo-rt">Rp 0</p>
                                <div class="w-full bg-gray-100 h-1.5 rounded-full mt-3"><div class="bg-purple-500 h-1.5 rounded-full" style="width: 20%"></div></div>
                            </div>
                        </div>
                    </div>

                    <!-- Mutasi Terakhir User -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 font-bold text-gray-700">Riwayat Transaksi Anda</div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <tbody class="divide-y divide-gray-100" id="warga-trx-table">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW LAPORAN WARGA (UPDATED TO MATCH ADMIN) -->
                <div id="warga-view-laporan" class="hidden-section fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Laporan Keuangan (Bulan Ini)</h1>
                        <span class="text-sm font-bold bg-blue-100 text-blue-800 px-3 py-1 rounded-full" id="warga-report-period">...</span>
                    </div>

                    <!-- TOTAL GABUNGAN CARD (WARGA) -->
                    <div class="bg-gradient-to-r from-blue-800 to-blue-900 rounded-xl p-6 shadow-lg mb-6 text-white relative overflow-hidden">
                        <div class="relative z-10 grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
                            <div>
                                <p class="text-blue-200 text-xs font-bold uppercase mb-1">Total Pemasukan</p>
                                <p class="text-2xl font-bold text-green-300" id="warga-report-total-in">Rp 0</p>
                            </div>
                            <div>
                                <p class="text-blue-200 text-xs font-bold uppercase mb-1">Total Pengeluaran</p>
                                <p class="text-2xl font-bold text-red-300" id="warga-report-total-out">Rp 0</p>
                            </div>
                            <div>
                                <p class="text-blue-200 text-xs font-bold uppercase mb-1">Total Selisih</p>
                                <p class="text-2xl font-bold text-white" id="warga-report-total-bal">Rp 0</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-chart-line absolute -right-6 -bottom-6 text-9xl opacity-10"></i>
                    </div>

                    <!-- Summary Cards per Category (WARGA) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Kas Perumahan -->
                        <div class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden">
                            <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
                                <h3 class="font-bold text-blue-800"><i class="fa-solid fa-building mr-2"></i>Kas Perumahan</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pemasukan</span>
                                    <span class="font-bold text-green-600" id="warga-report-housing-in">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pengeluaran</span>
                                    <span class="font-bold text-red-600" id="warga-report-housing-out">Rp 0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100 flex justify-between">
                                    <span class="font-bold text-gray-800">Selisih</span>
                                    <span class="font-bold text-blue-700" id="warga-report-housing-bal">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Dana Sosial -->
                        <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
                            <div class="bg-green-50 px-6 py-4 border-b border-green-100">
                                <h3 class="font-bold text-green-800"><i class="fa-solid fa-hand-holding-heart mr-2"></i>Dana Sosial</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pemasukan</span>
                                    <span class="font-bold text-green-600" id="warga-report-social-in">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pengeluaran</span>
                                    <span class="font-bold text-red-600" id="warga-report-social-out">Rp 0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100 flex justify-between">
                                    <span class="font-bold text-gray-800">Selisih</span>
                                    <span class="font-bold text-green-700" id="warga-report-social-bal">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Kas RT -->
                        <div class="bg-white rounded-xl shadow-sm border border-purple-100 overflow-hidden">
                            <div class="bg-purple-50 px-6 py-4 border-b border-purple-100">
                                <h3 class="font-bold text-purple-800"><i class="fa-solid fa-users-rays mr-2"></i>Kas RT</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pemasukan</span>
                                    <span class="font-bold text-green-600" id="warga-report-rt-in">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pengeluaran</span>
                                    <span class="font-bold text-red-600" id="warga-report-rt-out">Rp 0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100 flex justify-between">
                                    <span class="font-bold text-gray-800">Selisih</span>
                                    <span class="font-bold text-purple-700" id="warga-report-rt-bal">Rp 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Table (Mutasi Bulan Ini) -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800">Mutasi Transaksi (Bulan Ini)</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="bg-gray-50 text-gray-700 uppercase text-xs">
                                    <tr><th class="px-4 py-3">Tgl</th><th class="px-4 py-3">Uraian</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3">Tipe</th><th class="px-4 py-3 text-right">Nominal</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="warga-report-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>

    <!-- ========================================== -->
    <!-- 3. HALAMAN DASHBOARD ADMIN -->
    <!-- ========================================== -->
    <section id="page-admin" class="flex-1 flex h-full hidden-section">
        <aside class="w-64 bg-slate-900 text-white hidden md:flex flex-col shadow-xl z-20">
            <div class="p-6 border-b border-slate-800">
                <span class="text-xl font-bold tracking-wider text-blue-400 block">ADMIN</span>
                <span class="text-xs text-slate-400 mt-1">Rawinda Pratama</span>
            </div>
            <nav class="flex-1 px-4 space-y-2 mt-6 overflow-y-auto">
                <button onclick="switchAdminTab('dashboard')" id="nav-dashboard" class="admin-nav-item active w-full flex items-center px-4 py-3 bg-blue-600 rounded-lg text-white shadow-lg transition text-left"><i class="fa-solid fa-chart-pie w-6"></i> Dashboard</button>
                <button onclick="switchAdminTab('warga')" id="nav-warga" class="admin-nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition text-left"><i class="fa-solid fa-users w-6"></i> Data Warga</button>
                <button onclick="switchAdminTab('recap')" id="nav-recap" class="admin-nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition text-left"><i class="fa-solid fa-list-check w-6"></i> Rekap Pembayaran</button>
                <button onclick="switchAdminTab('transaksi')" id="nav-transaksi" class="admin-nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition group text-left">
                    <i class="fa-solid fa-receipt w-6"></i> Transaksi 
                    <span id="badge-pending" class="ml-auto bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="switchAdminTab('laporan')" id="nav-laporan" class="admin-nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition text-left"><i class="fa-solid fa-file-invoice w-6"></i> Laporan</button>
                <button onclick="switchAdminTab('settings')" id="nav-settings" class="admin-nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition text-left"><i class="fa-solid fa-gears w-6"></i> Pengaturan</button>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button onclick="logout()" class="flex items-center w-full px-4 py-2 text-slate-400 hover:text-white transition"><i class="fa-solid fa-right-from-bracket w-6"></i> Logout</button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100">
            <header class="bg-white shadow-sm h-16 flex items-center justify-between px-6 md:hidden z-10">
                <span class="font-bold text-gray-800 text-lg">Admin Panel</span>
                <button onclick="logout()" class="text-red-500"><i class="fa-solid fa-right-from-bracket"></i></button>
            </header>

            <main class="flex-1 overflow-y-auto p-6 md:p-8 relative">
                <!-- VIEW DASHBOARD -->
                <div id="admin-view-dashboard" class="admin-view fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div><h1 class="text-2xl font-bold text-gray-800">Ringkasan Keuangan</h1><p class="text-gray-500 text-sm mt-1" id="current-date-display">Senin, 02 Februari 2026</p></div>
                        <div class="flex space-x-3">
                            <button onclick="toggleModal('modal-income')" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-lg shadow-lg flex items-center transition"><i class="fa-solid fa-circle-plus mr-2"></i> Pemasukan</button>
                            <button onclick="toggleModal('modal-expense')" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-lg shadow-lg flex items-center transition"><i class="fa-solid fa-circle-minus mr-2"></i> Pengeluaran</button>
                        </div>
                    </div>
                    <!-- Cards Admin -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <p class="text-xs font-bold text-gray-400 uppercase">Total Kas Tunai</p>
                            <p class="text-3xl font-bold text-gray-800 mt-2" id="admin-saldo-total">Rp 0</p>
                        </div>
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                            <p class="text-xs font-bold text-blue-500 uppercase">Kas Perumahan</p>
                            <p class="text-2xl font-bold text-blue-900 mt-2" id="admin-saldo-housing">Rp 0</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                            <p class="text-xs font-bold text-green-500 uppercase">Dana Sosial</p>
                            <p class="text-2xl font-bold text-green-900 mt-2" id="admin-saldo-social">Rp 0</p>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-xl border border-purple-100">
                            <p class="text-xs font-bold text-purple-500 uppercase">Kas RT</p>
                            <p class="text-2xl font-bold text-purple-900 mt-2" id="admin-saldo-rt">Rp 0</p>
                        </div>
                    </div>
                    <!-- Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800">Statistik Keuangan Tahun Ini (Jan - Des)</h3>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Mutasi Bulanan (Net)</span>
                        </div>
                        <div class="h-80 w-full"><canvas id="financeChart"></canvas></div>
                    </div>
                </div>

                <!-- VIEW WARGA -->
                <div id="admin-view-warga" class="admin-view hidden-section fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Database Warga</h1>
                        <button onclick="toggleModal('modal-warga')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition"><i class="fa-solid fa-plus mr-1"></i> Tambah</button>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-700"><tr><th class="px-6 py-3">No. Rumah</th><th class="px-6 py-3">Nama KK</th><th class="px-6 py-3">Username</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-center">Aksi</th></tr></thead>
                            <tbody class="divide-y divide-gray-100" id="admin-warga-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW REKAP PEMBAYARAN -->
                <div id="admin-view-recap" class="admin-view hidden-section fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Rekap Pembayaran Warga</h1>
                        <span class="text-sm font-bold bg-blue-100 text-blue-800 px-3 py-1 rounded-full" id="recap-year-label">Tahun 2026</span>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600 whitespace-nowrap">
                                <thead class="bg-gray-50 text-xs uppercase text-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 sticky-col">Blok</th>
                                        <th class="px-4 py-3 sticky-col-2 border-r">Nama</th>
                                        <th class="px-2 py-3 text-center w-16">Jan</th>
                                        <th class="px-2 py-3 text-center w-16">Feb</th>
                                        <th class="px-2 py-3 text-center w-16">Mar</th>
                                        <th class="px-2 py-3 text-center w-16">Apr</th>
                                        <th class="px-2 py-3 text-center w-16">Mei</th>
                                        <th class="px-2 py-3 text-center w-16">Jun</th>
                                        <th class="px-2 py-3 text-center w-16">Jul</th>
                                        <th class="px-2 py-3 text-center w-16">Ags</th>
                                        <th class="px-2 py-3 text-center w-16">Sep</th>
                                        <th class="px-2 py-3 text-center w-16">Okt</th>
                                        <th class="px-2 py-3 text-center w-16">Nov</th>
                                        <th class="px-2 py-3 text-center w-16">Des</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="admin-recap-tbody">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW TRANSAKSI (VERIFIKASI) -->
                <div id="admin-view-transaksi" class="admin-view hidden-section fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Verifikasi Transaksi</h1>
                        <div class="text-sm text-gray-500">Pending Approval</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-700">
                                <tr><th class="px-6 py-3">Tanggal</th><th class="px-6 py-3">Info Warga</th><th class="px-6 py-3">Nominal</th><th class="px-6 py-3 text-center">Bukti</th><th class="px-6 py-3 text-center">Aksi</th></tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="admin-transaksi-tbody">
                                <!-- Rendered by JS -->
                            </tbody>
                        </table>
                        <div id="empty-pending-msg" class="hidden p-8 text-center text-gray-400 italic">Tidak ada transaksi menunggu verifikasi.</div>
                    </div>
                    
                    <h2 class="text-lg font-bold text-gray-800 mt-8 mb-4">Riwayat Transaksi Terakhir</h2>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="w-full text-sm text-left text-gray-600">
                            <tbody class="divide-y divide-gray-100" id="admin-history-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- VIEW LAPORAN (UPDATED) -->
                <div id="admin-view-laporan" class="admin-view hidden-section fade-in">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">Laporan Keuangan</h1>
                    
                    <!-- FILTER SECTION -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-col md:flex-row gap-4 items-center">
                        <div class="flex-1 w-full md:w-auto">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Bulan</label>
                            <select id="filter-month" class="w-full border p-2 rounded-lg text-sm bg-gray-50">
                                <option value="all">Semua Bulan</option>
                                <option value="1">Januari</option>
                                <option value="2">Februari</option>
                                <option value="3">Maret</option>
                                <option value="4">April</option>
                                <option value="5">Mei</option>
                                <option value="6">Juni</option>
                                <option value="7">Juli</option>
                                <option value="8">Agustus</option>
                                <option value="9">September</option>
                                <option value="10">Oktober</option>
                                <option value="11">November</option>
                                <option value="12">Desember</option>
                            </select>
                        </div>
                        <div class="flex-1 w-full md:w-auto">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tahun</label>
                            <select id="filter-year" class="w-full border p-2 rounded-lg text-sm bg-gray-50">
                                <option value="all">Semua Tahun</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="w-full md:w-auto">
                            <label class="block text-xs font-bold text-transparent mb-1">Action</label>
                            <button onclick="renderAdminReport()" class="w-full md:w-auto bg-gray-800 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-gray-900 transition"><i class="fa-solid fa-filter mr-2"></i>Tampilkan</button>
                        </div>
                    </div>

                    <!-- TOTAL GABUNGAN CARD -->
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-xl p-6 shadow-lg mb-6 text-white relative overflow-hidden">
                        <div class="relative z-10 grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Total Pemasukan</p>
                                <p class="text-2xl font-bold text-green-400" id="report-total-in">Rp 0</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Total Pengeluaran</p>
                                <p class="text-2xl font-bold text-red-400" id="report-total-out">Rp 0</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase mb-1">Total Selisih (Surplus/Defisit)</p>
                                <p class="text-2xl font-bold text-blue-400" id="report-total-bal">Rp 0</p>
                            </div>
                        </div>
                        <i class="fa-solid fa-coins absolute -right-6 -bottom-6 text-9xl opacity-10"></i>
                    </div>

                    <!-- Summary Cards per Category -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Kas Perumahan -->
                        <div class="bg-white rounded-xl shadow-sm border border-blue-100 overflow-hidden">
                            <div class="bg-blue-50 px-6 py-4 border-b border-blue-100">
                                <h3 class="font-bold text-blue-800"><i class="fa-solid fa-building mr-2"></i>Kas Perumahan</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pemasukan</span>
                                    <span class="font-bold text-green-600" id="report-housing-in">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pengeluaran</span>
                                    <span class="font-bold text-red-600" id="report-housing-out">Rp 0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100 flex justify-between">
                                    <span class="font-bold text-gray-800">Selisih</span>
                                    <span class="font-bold text-blue-700" id="report-housing-bal">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Dana Sosial -->
                        <div class="bg-white rounded-xl shadow-sm border border-green-100 overflow-hidden">
                            <div class="bg-green-50 px-6 py-4 border-b border-green-100">
                                <h3 class="font-bold text-green-800"><i class="fa-solid fa-hand-holding-heart mr-2"></i>Dana Sosial</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pemasukan</span>
                                    <span class="font-bold text-green-600" id="report-social-in">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pengeluaran</span>
                                    <span class="font-bold text-red-600" id="report-social-out">Rp 0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100 flex justify-between">
                                    <span class="font-bold text-gray-800">Selisih</span>
                                    <span class="font-bold text-green-700" id="report-social-bal">Rp 0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Kas RT -->
                        <div class="bg-white rounded-xl shadow-sm border border-purple-100 overflow-hidden">
                            <div class="bg-purple-50 px-6 py-4 border-b border-purple-100">
                                <h3 class="font-bold text-purple-800"><i class="fa-solid fa-users-rays mr-2"></i>Kas RT</h3>
                            </div>
                            <div class="p-6 space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pemasukan</span>
                                    <span class="font-bold text-green-600" id="report-rt-in">Rp 0</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Pengeluaran</span>
                                    <span class="font-bold text-red-600" id="report-rt-out">Rp 0</span>
                                </div>
                                <div class="pt-3 border-t border-gray-100 flex justify-between">
                                    <span class="font-bold text-gray-800">Selisih</span>
                                    <span class="font-bold text-purple-700" id="report-rt-bal">Rp 0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Table -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-800">Mutasi Transaksi</h3>
                            <span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500" id="report-filter-label">Semua Data</span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-600">
                                <thead class="bg-gray-50 text-gray-700 uppercase text-xs">
                                    <tr><th class="px-4 py-3">Tgl</th><th class="px-4 py-3">Uraian</th><th class="px-4 py-3">Kategori</th><th class="px-4 py-3">Tipe</th><th class="px-4 py-3 text-right">Nominal</th></tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="admin-report-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VIEW PENGATURAN (RESTORED & DYNAMIC) -->
                <div id="admin-view-settings" class="admin-view hidden-section fade-in">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">Pengaturan Sistem</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Pengaturan Tarif -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Atur Biaya Iuran Bulanan</h2>
                            <form onsubmit="handleSaveSettings(event)">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Iuran Perumahan</label>
                                        <div class="relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 font-bold">Rp</span><input type="number" id="set-housing" class="w-full pl-10 p-2 border border-gray-300 rounded-lg" oninput="calculateSettingsTotal()"></div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Iuran Dana Sosial</label>
                                        <div class="relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 font-bold">Rp</span><input type="number" id="set-social" class="w-full pl-10 p-2 border border-gray-300 rounded-lg" oninput="calculateSettingsTotal()"></div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-1">Iuran Kas RT</label>
                                        <div class="relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500 font-bold">Rp</span><input type="number" id="set-rt" class="w-full pl-10 p-2 border border-gray-300 rounded-lg" oninput="calculateSettingsTotal()"></div>
                                    </div>
                                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mt-2">
                                        <label class="block text-xs font-bold text-blue-800 mb-1 uppercase">Total Tagihan Warga</label>
                                        <div class="relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center text-blue-600 font-bold">Rp</span><input type="text" id="set-total" readonly class="w-full pl-10 p-1 border-0 bg-transparent font-mono text-xl font-extrabold text-blue-700 focus:ring-0"></div>
                                    </div>
                                    <button class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700 transition">Simpan Tarif Baru</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Pengaturan Bank -->
                         <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Rekening Pembayaran</h2>
                            <form onsubmit="event.preventDefault(); alert('Info Rekening Disimpan!');">
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Nama Bank</label><input type="text" value="BCA" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Nomor Rekening</label><input type="text" value="1234567890" class="w-full p-2 border border-gray-300 rounded-lg font-mono"></div>
                                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">Atas Nama</label><input type="text" value="Paguyuban Rawinda" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                                    <button class="w-full bg-gray-800 text-white font-bold py-2 rounded-lg hover:bg-gray-900 transition">Update Rekening</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </section>

    <!-- ========================================== -->
    <!-- MODALS -->
    <!-- ========================================== -->
    
    <!-- Modal Upload / Bayar (Warga) -->
    <div id="modal-upload" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative p-6">
            <h3 class="font-bold text-lg mb-4">Bayar Iuran Bulanan</h3>
            <form onsubmit="handleWargaPayment(event)">
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">Pilih Bulan (Bayar Dimuka Tersedia)</label>
                    <div id="month-checkboxes" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50">
                        <!-- Checkboxes will be injected here by JS -->
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Total Nominal</label>
                    <input type="text" id="pay-amount-display" value="Rp 0" readonly class="w-full border p-2 rounded bg-gray-100 font-bold text-blue-600 text-lg">
                    <input type="hidden" id="pay-amount-raw" value="0">
                </div>
                <!-- FILE UPLOAD FIX -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Bukti Transfer</label>
                    <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleFileSelect(this)">
                    
                    <div onclick="document.getElementById('file-upload').click()" class="border-2 border-dashed border-gray-300 rounded p-4 text-center cursor-pointer hover:bg-gray-50 transition" id="upload-area">
                        <div id="upload-placeholder">
                            <i class="fa-solid fa-image text-2xl text-gray-400 mb-2"></i>
                            <p class="text-xs text-gray-500">Klik untuk upload gambar bukti transfer</p>
                        </div>
                        <div id="upload-preview" class="hidden flex items-center justify-center text-green-600">
                             <i class="fa-solid fa-check-circle mr-2"></i> <span class="text-sm font-bold truncate" id="file-name-display"></span>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button type="button" onclick="toggleModal('modal-upload')" class="flex-1 bg-gray-200 py-2 rounded">Batal</button>
                    <button type="submit" id="btn-submit-pay" disabled class="flex-1 bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">Kirim</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Input Pemasukan / Pengeluaran (Admin) -->
    <div id="modal-trx" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative p-6">
            <h3 class="font-bold text-lg mb-4" id="modal-trx-title">Input Transaksi</h3>
            <form onsubmit="handleSubmitTransaction(event)">
                <input type="hidden" id="trx-type"> <!-- in / out -->
                
                <!-- NEW: Field Tanggal -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Tanggal Transaksi</label>
                    <input type="date" id="trx-date" required class="w-full border p-2 rounded bg-gray-50 text-gray-800 font-medium">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-1">Kategori</label>
                    <select id="trx-category" class="w-full border p-2 rounded bg-gray-50">
                        <option value="perumahan">Kas Perumahan</option>
                        <option value="sosial">Dana Sosial</option>
                        <option value="rt">Kas RT</option>
                    </select>
                </div>
                <div class="mb-4"><label class="block text-sm font-semibold mb-1">Keterangan</label><input type="text" id="trx-desc" required class="w-full border p-2 rounded" placeholder="Contoh: Beli Semen"></div>
                <div class="mb-4"><label class="block text-sm font-semibold mb-1">Nominal</label><input type="number" id="trx-amount" required class="w-full border p-2 rounded font-bold" placeholder="Rp"></div>
                <div class="flex gap-2">
                    <button type="button" onclick="toggleModal('modal-trx')" class="flex-1 bg-gray-200 py-2 rounded">Batal</button>
                    <button type="submit" class="flex-1 bg-gray-800 text-white py-2 rounded font-bold hover:bg-gray-900">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Tambah Warga -->
    <div id="modal-warga" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md relative p-6">
            <h3 class="font-bold text-lg mb-4">Tambah Warga</h3>
            <form onsubmit="handleAddWarga(event)">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="block text-sm font-semibold mb-1">Blok/No</label><input type="text" id="new-warga-no" required class="w-full border p-2 rounded uppercase" placeholder="A1-99"></div>
                    <div><label class="block text-sm font-semibold mb-1">Status</label><select id="new-warga-status" class="w-full border p-2 rounded"><option>Dihuni</option><option>Sewa</option></select></div>
                </div>
                <div class="mb-4"><label class="block text-sm font-semibold mb-1">Nama KK</label><input type="text" id="new-warga-name" required class="w-full border p-2 rounded"></div>
                <div class="mb-4"><label class="block text-sm font-semibold mb-1">Username</label><input type="text" id="new-warga-user" required class="w-full border p-2 rounded"></div>
                <div class="flex gap-2">
                    <button type="button" onclick="toggleModal('modal-warga')" class="flex-1 bg-gray-200 py-2 rounded">Batal</button>
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Bukti (View Only) -->
    <div id="modal-bukti" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-80 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm overflow-hidden">
            <div class="bg-gray-200 h-64 flex items-center justify-center"><i class="fa-regular fa-image text-4xl text-gray-400"></i></div>
            <div class="p-4">
                <p class="font-bold text-gray-800" id="view-bukti-desc">...</p>
                <p class="text-sm text-gray-500" id="view-bukti-info">...</p>
                <button onclick="toggleModal('modal-bukti')" class="w-full mt-4 bg-gray-800 text-white py-2 rounded">Tutup</button>
            </div>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- LOGIC JAVASCRIPT (STATE MANAGEMENT) -->
    <!-- ========================================== -->
    <script>
        // --- 1. INITIAL STATE (DUMMY DATABASE) ---
        
        // MENETAPKAN TANGGAL SISTEM (Simulasi: 2 Februari 2026)
        const APP_NOW = new Date('2026-02-02'); 

        // Config Default
        let dbConfig = {
            housing: 50000,
            social: 10000,
            rt: 10000,
            get total() { return this.housing + this.social + this.rt; }
        };

        // Data Warga (Tambahkan Bu Ratna dengan username user: d4-12)
        let dbWarga = [
            { id: 1, name: 'Budi Santoso', blok: 'A1-05', user: 'warga', pass: 'warga', role: 'warga' },
            { id: 2, name: 'Siti Aminah', blok: 'B2-10', user: 'b2-10', pass: '1234', role: 'warga' },
            { id: 3, name: 'Pak Doni', blok: 'C3-01', user: 'c3-01', pass: '1234', role: 'warga' },
            { id: 4, name: 'Bu Ratna', blok: 'D4-12', user: 'd4-12', pass: '1234', role: 'warga' }
        ];

        // Data Transaksi
        let dbTransaksi = [
            // Saldo Awal
            { id: 101, date: '2026-01-01', type: 'in', category: 'perumahan', amount: 8000000, desc: 'Saldo Awal 2026', status: 'verified', user: 'System' },
            { id: 102, date: '2026-01-01', type: 'in', category: 'sosial', amount: 2500000, desc: 'Saldo Awal 2026', status: 'verified', user: 'System' },
            { id: 103, date: '2026-01-01', type: 'in', category: 'rt', amount: 1200000, desc: 'Saldo Awal 2026', status: 'verified', user: 'System' },
            // Transaksi Warga (Verified)
            { id: 104, date: '2026-01-15', type: 'in', category: 'split', amount: 70000, desc: 'Iuran: Januari 2026', status: 'verified', user: 'Budi Santoso' },
            { id: 1041, date: '2026-01-16', type: 'in', category: 'split', amount: 70000, desc: 'Iuran: Januari 2026', status: 'verified', user: 'Siti Aminah' },
            
            // Transaksi Pending
            { id: 105, date: '2026-02-01', type: 'in', category: 'split', amount: 70000, desc: 'Iuran: Februari 2026', status: 'pending', user: 'Budi Santoso' },
            { id: 106, date: '2026-02-02', type: 'in', category: 'split', amount: 140000, desc: 'Iuran: Januari 2026, Februari 2026', status: 'pending', user: 'Pak Doni' },
            // Pengeluaran
            { id: 107, date: '2026-01-30', type: 'out', category: 'perumahan', amount: 150000, desc: 'Perbaikan Lampu', status: 'verified', user: 'Admin' },
            { id: 108, date: '2026-02-05', type: 'out', category: 'rt', amount: 50000, desc: 'Konsumsi Rapat', status: 'verified', user: 'Admin' }
        ];

        // --- RESTORED VARIABLES ---
        let currentUser = null; 
        let chartInstance = null; 
        let selectedMonths = [];

        // --- RESTORED AUTHENTICATION LOGIC ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('login-username').value.toLowerCase();
            const p = document.getElementById('login-password').value;

            if (u === 'admin' && p === 'admin') {
                currentUser = { name: 'Administrator', role: 'admin' };
                initAdmin();
                switchPage('page-admin');
                showToast('Login Berhasil sebagai Admin', 'success');
                return;
            }

            const warga = dbWarga.find(w => w.user === u && w.pass === p);
            if (warga) {
                currentUser = warga;
                initWarga();
                switchPage('page-warga');
                showToast(`Selamat datang, Bapak/Ibu ${warga.name}`, 'success');
                return;
            }

            showToast('Username atau password salah!', 'error');
        }

        function logout() {
            currentUser = null;
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            switchPage('page-login');
        }

        // --- RESTORED CORE LOGIC ---
        function calculateBalances() {
            let bal = { perumahan: 0, sosial: 0, rt: 0, total: 0 };
            let totalIn = 0;
            let totalOut = 0;

            dbTransaksi.forEach(t => {
                if (t.status === 'verified') {
                    if (t.category === 'split') {
                        // Split menggunakan Rasio Dinamis dari dbConfig
                        const totalFee = dbConfig.total;
                        let housingPart = (t.amount / totalFee) * dbConfig.housing;
                        let socialPart = (t.amount / totalFee) * dbConfig.social;
                        let rtPart = (t.amount / totalFee) * dbConfig.rt;

                        if(t.type === 'in') {
                            bal.perumahan += housingPart;
                            bal.sosial += socialPart;
                            bal.rt += rtPart;
                            totalIn += t.amount;
                        }
                    } else {
                        if (t.type === 'in') {
                            bal[t.category] += t.amount;
                            totalIn += t.amount;
                        } else {
                            bal[t.category] -= t.amount;
                            totalOut += t.amount;
                        }
                    }
                }
            });
            bal.total = bal.perumahan + bal.sosial + bal.rt;
            return { bal, totalIn, totalOut };
        }

        // --- WARGA RENDERER (UPDATED LOGIC) ---
        function initWarga() {
            document.getElementById('warga-nav-name').innerText = currentUser.name;
            document.getElementById('warga-nav-blok').innerText = currentUser.blok;

            const { bal, totalIn, totalOut } = calculateBalances();
            
            formatId('global-saldo-total', bal.total);
            formatId('global-saldo-housing', bal.perumahan);
            formatId('global-saldo-social', bal.sosial);
            formatId('global-saldo-rt', bal.rt);

            // 1. HITUNG TUNGGAKAN & TAGIHAN
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentYear = APP_NOW.getFullYear();
            const currentMonthIndex = APP_NOW.getMonth(); // 0 = Jan, 1 = Feb (Sesuai tgl sistem)
            
            let unpaidMonthsCount = 0;
            let unpaidMonthsNames = [];

            // Loop dari Januari sampai Bulan Ini (Inclusive)
            for (let i = 0; i <= currentMonthIndex; i++) {
                const checkMonth = monthNames[i];
                
                // Cek apakah sudah Verified atau Pending
                const isPaidOrPending = dbTransaksi.some(t => 
                    t.user === currentUser.name && 
                    (t.status === 'verified' || t.status === 'pending') && 
                    t.desc.includes(checkMonth) && 
                    t.desc.includes(currentYear.toString())
                );

                if (!isPaidOrPending) {
                    unpaidMonthsCount++;
                    unpaidMonthsNames.push(checkMonth);
                }
            }

            const totalTagihan = unpaidMonthsCount * dbConfig.total;

            // Render Transaksi Table
            const tbody = document.getElementById('warga-trx-table');
            tbody.innerHTML = '';
            const myTrx = dbTransaksi.filter(t => t.user === currentUser.name).sort((a,b) => b.id - a.id);

            let hasPending = false;
            let pendingAmount = 0;

            myTrx.forEach(t => {
                const color = t.type === 'in' ? 'text-green-600' : 'text-red-600';
                const sign = t.type === 'in' ? '+' : '-';
                const statusBadge = t.status === 'verified' 
                    ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Berhasil</span>' 
                    : '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Pending</span>';
                
                if (t.status === 'pending') {
                    hasPending = true;
                    pendingAmount += t.amount;
                }

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-4 w-24 text-gray-500 text-xs">${t.date}</td>
                        <td class="px-6 py-4 font-medium text-gray-800">
                            ${t.desc}
                            ${t.status === 'verified' ? '<i class="fa-solid fa-check-circle text-blue-500 ml-1 text-xs" title="Verified"></i>' : ''}
                        </td>
                        <td class="px-6 py-4 text-right font-bold ${color}">${sign} ${formatRupiah(t.amount)}</td>
                        <td class="px-6 py-4 text-right">${statusBadge}</td>
                    </tr>
                `;
            });

            // 2. UPDATE KARTU STATUS TAGIHAN
            const card = document.getElementById('card-tagihan');
            const cardBg = document.getElementById('card-tagihan-bg');
            const cardTitle = document.getElementById('card-tagihan-title');
            const cardDesc = document.getElementById('card-tagihan-desc');
            const btnBayar = document.getElementById('btn-bayar-utama');
            const amountDisplay = document.getElementById('warga-bill-amount');

            if (hasPending) {
                // PRIORITAS 1: JIKA ADA YANG PENDING (Kuning)
                card.className = "bg-white rounded-xl shadow-sm border-l-4 border-yellow-500 overflow-hidden transition-all duration-300";
                cardBg.className = "p-6 flex flex-col sm:flex-row justify-between items-center bg-yellow-50/50";
                cardTitle.innerHTML = `<i class="fa-solid fa-clock-rotate-left mr-2"></i> Pembayaran Sedang Diproses`;
                cardTitle.className = "text-sm text-yellow-700 font-bold flex items-center";
                amountDisplay.innerText = formatRupiah(pendingAmount);
                cardDesc.innerText = "Menunggu Konfirmasi Admin";
                btnBayar.classList.add('hidden'); // Sembunyikan tombol bayar saat pending
            } else if (totalTagihan > 0) {
                // PRIORITAS 2: JIKA ADA TUNGGAKAN (Merah)
                card.className = "bg-white rounded-xl shadow-sm border-l-4 border-red-500 overflow-hidden transition-all duration-300";
                cardBg.className = "p-6 flex flex-col sm:flex-row justify-between items-center bg-red-50/50";
                cardTitle.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> Tagihan Belum Dibayar`;
                cardTitle.className = "text-sm text-red-600 font-bold flex items-center";
                amountDisplay.innerText = formatRupiah(totalTagihan);
                // Tampilkan rincian bulan yg nunggak (maks 2 bulan ditampilkan textnya)
                let descText = unpaidMonthsNames.slice(0, 3).join(', ');
                if(unpaidMonthsNames.length > 3) descText += ", dst";
                cardDesc.innerText = `Tunggakan: ${descText}`;
                
                btnBayar.classList.remove('hidden');
                btnBayar.innerText = "Bayar Tunggakan";
            } else {
                // PRIORITAS 3: LUNAS (Hijau/Biru)
                card.className = "bg-white rounded-xl shadow-sm border-l-4 border-green-500 overflow-hidden transition-all duration-300";
                cardBg.className = "p-6 flex flex-col sm:flex-row justify-between items-center bg-green-50/50";
                cardTitle.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> Tidak Ada Tagihan`;
                cardTitle.className = "text-sm text-green-700 font-bold flex items-center";
                amountDisplay.innerText = "Lunas";
                cardDesc.innerText = "Terima kasih sudah membayar tepat waktu";
                
                btnBayar.classList.remove('hidden');
                btnBayar.innerText = "Bayar Dimuka"; // Ubah teks jadi bayar advance
            }

            renderWargaReport();
        }

        // NEW FUNCTION: Render Warga Report (Mirrors Admin Report logic but for current month)
        function renderWargaReport() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = now.getFullYear();

            // Set Period Label
            const monthNames = ["", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            document.getElementById('warga-report-period').innerText = `Periode: ${monthNames[currentMonth]} ${currentYear}`;

            // Initialize Report Structure
            let report = {
                perumahan: { in: 0, out: 0 },
                sosial: { in: 0, out: 0 },
                rt: { in: 0, out: 0 }
            };

            // Filter & Calculate (Only Current Month, Status Verified)
            const filteredData = dbTransaksi.filter(t => {
                if(t.status !== 'verified') return false;
                
                const d = new Date(t.date);
                const matchMonth = (d.getMonth() + 1) === currentMonth;
                const matchYear = d.getFullYear() === currentYear;
                
                return matchMonth && matchYear;
            });

            // Aggregate Data
            filteredData.forEach(t => {
                if (t.category === 'split') {
                    // Split Logic
                    const totalFee = dbConfig.total;
                    let h = (t.amount / totalFee) * dbConfig.housing;
                    let s = (t.amount / totalFee) * dbConfig.social;
                    let r = (t.amount / totalFee) * dbConfig.rt;

                    if(t.type === 'in') {
                        report.perumahan.in += h;
                        report.sosial.in += s;
                        report.rt.in += r;
                    } 
                } else {
                    // Direct Category Logic
                    if (report[t.category]) {
                        if (t.type === 'in') report[t.category].in += t.amount;
                        else report[t.category].out += t.amount;
                    }
                }
            });

            // Calculate Global Totals
            const totalIn = report.perumahan.in + report.sosial.in + report.rt.in;
            const totalOut = report.perumahan.out + report.sosial.out + report.rt.out;
            const totalNet = totalIn - totalOut;

            // Update DOM - Grand Totals
            formatId('warga-report-total-in', totalIn);
            formatId('warga-report-total-out', totalOut);
            formatId('warga-report-total-bal', totalNet);

            // Update DOM - Categories
            formatId('warga-report-housing-in', report.perumahan.in);
            formatId('warga-report-housing-out', report.perumahan.out);
            formatId('warga-report-housing-bal', report.perumahan.in - report.perumahan.out);

            formatId('warga-report-social-in', report.sosial.in);
            formatId('warga-report-social-out', report.sosial.out);
            formatId('warga-report-social-bal', report.sosial.in - report.sosial.out);

            formatId('warga-report-rt-in', report.rt.in);
            formatId('warga-report-rt-out', report.rt.out);
            formatId('warga-report-rt-bal', report.rt.in - report.rt.out);

            // Render Table
            const tbody = document.getElementById('warga-report-tbody');
            tbody.innerHTML = '';
            
            const tableData = filteredData.sort((a,b) => b.id - a.id);
            
            if(tableData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400 italic">Belum ada transaksi untuk bulan ini.</td></tr>`;
            } else {
                tableData.forEach(t => {
                    const color = t.type === 'in' ? 'text-green-600' : 'text-red-600';
                    const sign = t.type === 'in' ? '+' : '-';
                    const rowHtml = `
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="px-4 py-3">${t.date}</td>
                            <td class="px-4 py-3 font-medium">${t.desc} <span class="text-xs text-gray-400">(${t.user})</span></td>
                            <td class="px-4 py-3 text-xs uppercase badge"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded">${t.category}</span></td>
                            <td class="px-4 py-3 text-xs uppercase">${t.type === 'in' ? 'Masuk' : 'Keluar'}</td>
                            <td class="px-4 py-3 text-right font-bold ${color}">${sign} ${formatRupiah(t.amount)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += rowHtml;
                });
            }
        }

        // --- ADMIN RENDERER ---
        function initAdmin() {
            const today = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('current-date-display').innerText = today;

            renderAdminDashboard();
            renderAdminWargaTable();
            renderAdminTransactions();
            renderAdminChart(); // Updated to Line Chart
            initAdminSettings(); 
            renderAdminReport(); 
            renderAdminRecap(); // New Recap Table
        }

        // RESTORED FUNCTIONS:
        function renderAdminDashboard() {
            const { bal } = calculateBalances();
            formatId('admin-saldo-total', bal.total);
            formatId('admin-saldo-housing', bal.perumahan);
            formatId('admin-saldo-social', bal.sosial);
            formatId('admin-saldo-rt', bal.rt);
        }

        function renderAdminWargaTable() {
            const tbody = document.getElementById('admin-warga-tbody');
            tbody.innerHTML = '';
            dbWarga.forEach(w => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-4 font-bold">${w.blok}</td>
                        <td class="px-6 py-4">${w.name}</td>
                        <td class="px-6 py-4 font-mono text-xs text-blue-600">${w.user}</td>
                        <td class="px-6 py-4"><span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Aktif</span></td>
                        <td class="px-6 py-4 text-center">
                            <button class="text-blue-500 hover:text-blue-700 transition"><i class="fa-solid fa-pen-to-square"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function renderAdminTransactions() {
            const pendingBody = document.getElementById('admin-transaksi-tbody');
            const pendingMsg = document.getElementById('empty-pending-msg');
            const pendingData = dbTransaksi.filter(t => t.status === 'pending');
            
            pendingBody.innerHTML = '';
            
            const badge = document.getElementById('badge-pending');
            if(pendingData.length > 0) {
                if(badge) {
                    badge.innerText = pendingData.length;
                    badge.classList.remove('hidden');
                }
                pendingMsg.classList.add('hidden');
            } else {
                if(badge) badge.classList.add('hidden');
                pendingMsg.classList.remove('hidden');
            }

            pendingData.forEach(t => {
                pendingBody.innerHTML += `
                    <tr class="bg-yellow-50 border-b hover:bg-yellow-100 transition">
                        <td class="px-6 py-4">${t.date}</td>
                        <td class="px-6 py-4 font-medium text-gray-800">${t.user}<br><span class="text-xs text-gray-500">${t.desc}</span></td>
                        <td class="px-6 py-4 font-bold text-gray-800">${formatRupiah(t.amount)}</td>
                        <td class="px-6 py-4 text-center"><button onclick="viewBukti('${t.desc}', '${t.amount}')" class="text-blue-600 underline text-xs">Lihat</button></td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="handleVerify(${t.id}, 'verified')" class="bg-green-500 text-white p-1.5 rounded hover:bg-green-600 mr-1 shadow"><i class="fa-solid fa-check"></i></button>
                            <button onclick="handleVerify(${t.id}, 'rejected')" class="bg-red-500 text-white p-1.5 rounded hover:bg-red-600 shadow"><i class="fa-solid fa-xmark"></i></button>
                        </td>
                    </tr>
                `;
            });

            const historyBody = document.getElementById('admin-history-tbody');
            historyBody.innerHTML = '';
            
            const historyData = dbTransaksi.filter(t => t.status !== 'pending').sort((a,b) => b.id - a.id);
            
            historyData.forEach(t => {
                const color = t.type === 'in' ? 'text-green-600' : 'text-red-600';
                const sign = t.type === 'in' ? '+' : '-';
                const rowHtml = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-4">${t.date}</td>
                        <td class="px-6 py-4 font-medium">${t.desc} <span class="text-xs text-gray-400">(${t.user})</span></td>
                        <td class="px-6 py-4 text-xs uppercase badge">${t.category}</td>
                        <td class="px-6 py-4 text-right font-bold ${color}">${sign} ${formatRupiah(t.amount)}</td>
                    </tr>
                `;
                if(historyBody.children.length < 5) historyBody.innerHTML += rowHtml; 
            });
        }

        function initAdminSettings() {
            document.getElementById('set-housing').value = dbConfig.housing;
            document.getElementById('set-social').value = dbConfig.social;
            document.getElementById('set-rt').value = dbConfig.rt;
            calculateSettingsTotal();
        }

        function calculateSettingsTotal() {
            const h = parseInt(document.getElementById('set-housing').value) || 0;
            const s = parseInt(document.getElementById('set-social').value) || 0;
            const r = parseInt(document.getElementById('set-rt').value) || 0;
            const total = h + s + r;
            document.getElementById('set-total').value = formatRupiah(total);
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            dbConfig.housing = parseInt(document.getElementById('set-housing').value) || 0;
            dbConfig.social = parseInt(document.getElementById('set-social').value) || 0;
            dbConfig.rt = parseInt(document.getElementById('set-rt').value) || 0;
            
            showToast('Tarif Baru Disimpan! Tagihan warga akan otomatis mengikuti tarif baru.', 'success');
        }

        // NEW: Render Recap Table Matrix
        function renderAdminRecap() {
            const tbody = document.getElementById('admin-recap-tbody');
            tbody.innerHTML = '';
            
            const currentYear = new Date().getFullYear();
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            document.getElementById('recap-year-label').innerText = `Tahun ${currentYear}`;

            dbWarga.forEach(w => {
                let row = `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 sticky-col font-bold text-gray-700">${w.blok}</td>
                    <td class="px-4 py-3 sticky-col-2 border-r bg-white">${w.name}</td>`;
                
                // Check payment for each month
                for(let i=0; i<12; i++) {
                    const monthName = monthNames[i];
                    // Logic: Check if verified transaction exists for this user containing the month name and current year
                    const isPaid = dbTransaksi.some(t => 
                        t.user === w.name && 
                        t.status === 'verified' && 
                        t.desc.includes(monthName) && 
                        t.desc.includes(currentYear.toString())
                    );

                    if(isPaid) {
                        row += `<td class="px-2 py-3 text-center"><i class="fa-solid fa-check text-green-500"></i></td>`;
                    } else {
                        // Optional: Check pending
                        const isPending = dbTransaksi.some(t => 
                            t.user === w.name && 
                            t.status === 'pending' && 
                            t.desc.includes(monthName) && 
                            t.desc.includes(currentYear.toString())
                        );
                        if(isPending) {
                            row += `<td class="px-2 py-3 text-center"><i class="fa-solid fa-clock text-yellow-500"></i></td>`;
                        } else {
                            row += `<td class="px-2 py-3 text-center"><span class="text-gray-200">-</span></td>`;
                        }
                    }
                }
                
                row += `</tr>`;
                tbody.innerHTML += row;
            });
        }

        // NEW: Updated Chart Logic (Monthly Trend)
        function renderAdminChart() {
            if(chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('financeChart').getContext('2d');
            
            // Prepare Data Containers (Jan-Dec)
            const housingData = new Array(12).fill(0);
            const socialData = new Array(12).fill(0);
            const rtData = new Array(12).fill(0);
            
            const currentYear = new Date().getFullYear();

            // Populate Data
            dbTransaksi.forEach(t => {
                if(t.status === 'verified') {
                    const d = new Date(t.date);
                    if(d.getFullYear() === currentYear) {
                        const mIndex = d.getMonth(); // 0-11
                        
                        // Logic Accumulation (Adding up transactions per month)
                        if (t.category === 'split') {
                            const totalFee = dbConfig.total;
                            housingData[mIndex] += (t.amount / totalFee) * dbConfig.housing;
                            socialData[mIndex] += (t.amount / totalFee) * dbConfig.social;
                            rtData[mIndex] += (t.amount / totalFee) * dbConfig.rt;
                        } else if (t.category === 'perumahan') {
                             if(t.type === 'in') housingData[mIndex] += t.amount;
                             else housingData[mIndex] -= t.amount;
                        } else if (t.category === 'sosial') {
                             if(t.type === 'in') socialData[mIndex] += t.amount;
                             else socialData[mIndex] -= t.amount;
                        } else if (t.category === 'rt') {
                             if(t.type === 'in') rtData[mIndex] += t.amount;
                             else rtData[mIndex] -= t.amount;
                        }
                    }
                }
            });

            // REMOVED CUMULATIVE LOGIC (Agar bulan yang tidak ada transaksi jadi 0)

            chartInstance = new Chart(ctx, {
                type: 'bar', // Menggunakan Column Chart
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [
                        {
                            label: 'Kas Perumahan',
                            data: housingData,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // Opacity ditingkatkan agar bar lebih jelas
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Dana Sosial',
                            data: socialData,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Kas RT',
                            data: rtData,
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.8)',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + (value/1000).toLocaleString() + 'k';
                                }
                            }
                        } 
                    }
                }
            });
        }

        function renderAdminReport() {
            // 1. Get Filters
            const filterMonth = document.getElementById('filter-month').value;
            const filterYear = document.getElementById('filter-year').value;

            // Update Label
            let filterLabel = "Semua Data";
            if(filterMonth !== 'all' || filterYear !== 'all') {
                const monthNames = ["", "Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                let m = filterMonth !== 'all' ? monthNames[filterMonth] : "";
                let y = filterYear !== 'all' ? filterYear : "";
                filterLabel = `Periode: ${m} ${y}`;
            }
            document.getElementById('report-filter-label').innerText = filterLabel;

            // 2. Initialize Report Structure
            let report = {
                perumahan: { in: 0, out: 0 },
                sosial: { in: 0, out: 0 },
                rt: { in: 0, out: 0 }
            };

            // 3. Filter & Calculate
            const filteredData = dbTransaksi.filter(t => {
                if(t.status !== 'verified') return false;
                
                const d = new Date(t.date);
                const matchMonth = filterMonth === 'all' || (d.getMonth() + 1) == filterMonth;
                const matchYear = filterYear === 'all' || d.getFullYear() == filterYear;
                
                return matchMonth && matchYear;
            });

            // 4. Aggregate Data
            filteredData.forEach(t => {
                if (t.category === 'split') {
                    // Split Logic
                    const totalFee = dbConfig.total;
                    let h = (t.amount / totalFee) * dbConfig.housing;
                    let s = (t.amount / totalFee) * dbConfig.social;
                    let r = (t.amount / totalFee) * dbConfig.rt;

                    if(t.type === 'in') {
                        report.perumahan.in += h;
                        report.sosial.in += s;
                        report.rt.in += r;
                    } 
                } else {
                    // Direct Category Logic
                    if (report[t.category]) {
                        if (t.type === 'in') report[t.category].in += t.amount;
                        else report[t.category].out += t.amount;
                    }
                }
            });

            // 5. Calculate Global Totals (Filtered)
            const totalIn = report.perumahan.in + report.sosial.in + report.rt.in;
            const totalOut = report.perumahan.out + report.sosial.out + report.rt.out;
            const totalNet = totalIn - totalOut;

            // 6. Update DOM - Grand Totals
            formatId('report-total-in', totalIn);
            formatId('report-total-out', totalOut);
            formatId('report-total-bal', totalNet); // Shows Surplus/Deficit for selected period

            // 7. Update DOM - Categories
            formatId('report-housing-in', report.perumahan.in);
            formatId('report-housing-out', report.perumahan.out);
            formatId('report-housing-bal', report.perumahan.in - report.perumahan.out);

            formatId('report-social-in', report.sosial.in);
            formatId('report-social-out', report.sosial.out);
            formatId('report-social-bal', report.sosial.in - report.sosial.out);

            formatId('report-rt-in', report.rt.in);
            formatId('report-rt-out', report.rt.out);
            formatId('report-rt-bal', report.rt.in - report.rt.out);
            
            // 8. Update Table
            const reportBody = document.getElementById('admin-report-tbody');
            reportBody.innerHTML = '';
            
            // Sort by date desc
            const tableData = filteredData.sort((a,b) => b.id - a.id);
            
            if(tableData.length === 0) {
                reportBody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400 italic">Tidak ada transaksi untuk periode ini.</td></tr>`;
            } else {
                tableData.forEach(t => {
                    const color = t.type === 'in' ? 'text-green-600' : 'text-red-600';
                    const sign = t.type === 'in' ? '+' : '-';
                    const rowHtml = `
                        <tr class="hover:bg-gray-50 border-b">
                            <td class="px-4 py-3">${t.date}</td>
                            <td class="px-4 py-3 font-medium">${t.desc} <span class="text-xs text-gray-400">(${t.user})</span></td>
                            <td class="px-4 py-3 text-xs uppercase badge"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded">${t.category}</span></td>
                            <td class="px-4 py-3 text-xs uppercase">${t.type === 'in' ? 'Masuk' : 'Keluar'}</td>
                            <td class="px-4 py-3 text-right font-bold ${color}">${sign} ${formatRupiah(t.amount)}</td>
                        </tr>
                    `;
                    reportBody.innerHTML += rowHtml;
                });
            }
        }

        // --- ACTIONS & EVENT HANDLERS ---

        // 1. OPEN PAYMENT MODAL & GENERATE MONTHS (UPDATED LOGIC)
        function openPaymentModal() {
            const container = document.getElementById('month-checkboxes');
            container.innerHTML = '';
            selectedMonths = [];
            updateTotalPayment();

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const currentYear = APP_NOW.getFullYear();
            const currentMonthIndex = APP_NOW.getMonth(); 

            // Generate semua bulan di tahun ini yang BELUM LUNAS
            // Logic: Tampilkan Jan - Des, tapi disable/hide yang sudah lunas.
            // Fokus: Tampilkan Tunggakan (Bulan lalu yg belum lunas) + Bulan Depan
            
            for(let i = 0; i < 12; i++) {
                let monthStr = `${monthNames[i]} ${currentYear}`;
                
                // Cek Status Pembayaran (Verified atau Pending)
                const isPaid = dbTransaksi.some(t => 
                    t.user === currentUser.name && 
                    t.status === 'verified' && 
                    t.desc.includes(monthNames[i]) && 
                    t.desc.includes(currentYear.toString())
                );
                
                const isPending = dbTransaksi.some(t => 
                     t.user === currentUser.name && 
                     t.status === 'pending' && 
                     t.desc.includes(monthNames[i]) && 
                     t.desc.includes(currentYear.toString())
                );

                // Skip jika sudah Verified atau Pending
                if(isPaid || isPending) continue;

                // Tentukan Label Tambahan (Tunggakan / Bulan Ini)
                let extraLabel = "";
                let labelColor = "text-gray-700";
                let borderColor = "border-gray-200";

                if (i < currentMonthIndex) {
                    extraLabel = `<span class="ml-2 bg-red-100 text-red-600 text-[10px] font-bold px-1.5 py-0.5 rounded">TUNGGAKAN</span>`;
                    labelColor = "text-red-700 font-bold";
                    borderColor = "border-red-200 bg-red-50";
                } else if (i === currentMonthIndex) {
                    extraLabel = `<span class="ml-2 bg-blue-100 text-blue-600 text-[10px] font-bold px-1.5 py-0.5 rounded">BULAN INI</span>`;
                    labelColor = "text-blue-700 font-bold";
                    borderColor = "border-blue-200 bg-blue-50";
                }

                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 border rounded hover:bg-gray-50 cursor-pointer ${borderColor}`;
                div.onclick = function(e) {
                    if(e.target.type !== 'checkbox') {
                        const cb = this.querySelector('input');
                        cb.checked = !cb.checked;
                        toggleMonth(monthStr, cb.checked);
                    }
                };

                div.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" value="${monthStr}" class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500 cursor-pointer" onchange="toggleMonth('${monthStr}', this.checked)">
                        <div class="flex flex-col ml-3">
                            <span class="text-sm ${labelColor}">${monthStr} ${extraLabel}</span>
                        </div>
                    </div>
                    <span class="text-xs font-bold text-gray-500">${formatRupiah(dbConfig.total)}</span>
                `;
                container.appendChild(div);
            }
            
            // Reset Upload UI
            document.getElementById('file-upload').value = '';
            document.getElementById('upload-placeholder').classList.remove('hidden');
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-preview').classList.remove('flex');

            toggleModal('modal-upload');
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                document.getElementById('upload-placeholder').classList.add('hidden');
                document.getElementById('upload-preview').classList.remove('hidden');
                document.getElementById('upload-preview').classList.add('flex');
                document.getElementById('file-name-display').innerText = input.files[0].name;
            }
        }

        function toggleMonth(month, isChecked) {
            if(isChecked) {
                selectedMonths.push(month);
            } else {
                selectedMonths = selectedMonths.filter(m => m !== month);
            }
            updateTotalPayment();
        }

        function updateTotalPayment() {
            const total = selectedMonths.length * dbConfig.total; // Use Dynamic Config
            document.getElementById('pay-amount-raw').value = total;
            document.getElementById('pay-amount-display').value = formatRupiah(total);
            document.getElementById('btn-submit-pay').disabled = total === 0;
        }

        // 2. Warga Bayar
        function handleWargaPayment(e) {
            e.preventDefault();
            const amount = parseInt(document.getElementById('pay-amount-raw').value);
            if(amount === 0) return;

            // Sort months to look nice in description
            const desc = `Iuran: ${selectedMonths.join(', ')}`;
            
            const newTrx = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type: 'in',
                category: 'split',
                amount: amount,
                desc: desc,
                status: 'pending',
                user: currentUser.name
            };

            dbTransaksi.push(newTrx);
            toggleModal('modal-upload');
            showToast('Bukti pembayaran terkirim! Menunggu konfirmasi admin.', 'success');
            initWarga(); // Refresh UI to show Processing Status
        }

        // 3. Admin Verifikasi
        function handleVerify(id, status) {
            const idx = dbTransaksi.findIndex(t => t.id === id);
            if (idx !== -1) {
                dbTransaksi[idx].status = status;
                initAdmin(); 
                showToast(`Transaksi ${status === 'verified' ? 'Diterima' : 'Ditolak'}`, status === 'verified' ? 'success' : 'error');
            }
        }

        // 4. Modal Toggles
        function toggleModal(id) {
            const el = document.getElementById(id);
            if(id === 'modal-income') {
                document.getElementById('modal-trx').classList.remove('hidden');
                document.getElementById('modal-trx-title').innerText = "Input Pemasukan Lainnya";
                document.getElementById('trx-type').value = 'in';
                document.getElementById('trx-amount').classList.remove('text-red-600');
                document.getElementById('trx-amount').classList.add('text-green-600');
                
                // Set Default Date to Today
                document.getElementById('trx-date').value = new Date().toISOString().split('T')[0];
                return;
            }
            if(id === 'modal-expense') {
                document.getElementById('modal-trx').classList.remove('hidden');
                document.getElementById('modal-trx-title').innerText = "Catat Pengeluaran";
                document.getElementById('trx-type').value = 'out';
                document.getElementById('trx-amount').classList.remove('text-green-600');
                document.getElementById('trx-amount').classList.add('text-red-600');
                
                // Set Default Date to Today
                document.getElementById('trx-date').value = new Date().toISOString().split('T')[0];
                return;
            }
            el.classList.toggle('hidden');
        }

        function handleSubmitTransaction(e) {
            e.preventDefault();
            const type = document.getElementById('trx-type').value;
            const date = document.getElementById('trx-date').value; // Get Selected Date
            const cat = document.getElementById('trx-category').value;
            const desc = document.getElementById('trx-desc').value;
            const amount = parseInt(document.getElementById('trx-amount').value);

            const newTrx = {
                id: Date.now(),
                date: date, // Use user selected date
                type: type,
                category: cat,
                amount: amount,
                desc: desc,
                status: 'verified', 
                user: 'Admin'
            };

            dbTransaksi.push(newTrx);
            toggleModal('modal-trx');
            showToast('Data berhasil disimpan!', 'success');
            
            document.getElementById('trx-desc').value = '';
            document.getElementById('trx-amount').value = '';
            
            initAdmin();
        }

        function handleAddWarga(e) {
            e.preventDefault();
            const no = document.getElementById('new-warga-no').value;
            const name = document.getElementById('new-warga-name').value;
            const user = document.getElementById('new-warga-user').value;

            dbWarga.push({
                id: Date.now(),
                name: name,
                blok: no,
                user: user,
                pass: '1234', 
                role: 'warga'
            });

            toggleModal('modal-warga');
            showToast('Warga baru berhasil ditambahkan', 'success');
            renderAdminWargaTable();
        }

        // --- SETTINGS LOGIC ---
        function initAdminSettings() {
            document.getElementById('set-housing').value = dbConfig.housing;
            document.getElementById('set-social').value = dbConfig.social;
            document.getElementById('set-rt').value = dbConfig.rt;
            calculateSettingsTotal();
        }

        function calculateSettingsTotal() {
            const h = parseInt(document.getElementById('set-housing').value) || 0;
            const s = parseInt(document.getElementById('set-social').value) || 0;
            const r = parseInt(document.getElementById('set-rt').value) || 0;
            const total = h + s + r;
            document.getElementById('set-total').value = formatRupiah(total);
        }

        function handleSaveSettings(e) {
            e.preventDefault();
            dbConfig.housing = parseInt(document.getElementById('set-housing').value) || 0;
            dbConfig.social = parseInt(document.getElementById('set-social').value) || 0;
            dbConfig.rt = parseInt(document.getElementById('set-rt').value) || 0;
            
            showToast('Tarif Baru Disimpan! Tagihan warga akan otomatis mengikuti tarif baru.', 'success');
        }


        function formatRupiah(num) {
            return 'Rp ' + num.toLocaleString('id-ID');
        }

        function formatId(id, num) {
            const el = document.getElementById(id);
            if(el) el.innerText = formatRupiah(num);
        }

        function switchPage(pageId) {
            ['page-login', 'page-warga', 'page-admin'].forEach(id => document.getElementById(id).classList.add('hidden-section'));
            document.getElementById(pageId).classList.remove('hidden-section');
        }

        function switchWargaTab(tab) {
            if(tab === 'home') {
                document.getElementById('warga-view-home').classList.remove('hidden-section');
                document.getElementById('warga-view-laporan').classList.add('hidden-section');
            } else {
                document.getElementById('warga-view-home').classList.add('hidden-section');
                document.getElementById('warga-view-laporan').classList.remove('hidden-section');
            }
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-view').forEach(el => el.classList.add('hidden-section'));
            document.getElementById('admin-view-'+tab).classList.remove('hidden-section');
            document.querySelectorAll('.admin-nav-item').forEach(el => {
                el.className = 'admin-nav-item w-full flex items-center px-4 py-3 text-slate-300 hover:bg-slate-800 hover:text-white rounded-lg transition text-left';
            });
            document.getElementById('nav-'+tab).className = 'admin-nav-item active w-full flex items-center px-4 py-3 bg-blue-600 rounded-lg text-white shadow-lg transition text-left';
        }

        function viewBukti(desc, amount) {
            document.getElementById('view-bukti-desc').innerText = desc;
            document.getElementById('view-bukti-info').innerText = "Nominal: " + formatRupiah(amount);
            toggleModal('modal-bukti');
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'success' ? 'bg-green-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
            
            toast.className = `${color} text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full flex items-center`;
            toast.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-check' : 'fa-info-circle'} mr-2"></i> ${msg}`;
            
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
